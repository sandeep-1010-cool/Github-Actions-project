name: Infrastructure Visual Review

on:
  workflow_dispatch:
    inputs:
      stack:
        description: 'Stack to review'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - prod
      review_type:
        description: 'Type of review'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - diagram
          - detailed
          - safe-diagram

env:
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

jobs:
  infrastructure-review:
    name: Visual Infrastructure Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd pulumi_project
          npm install

      - name: Install Pulumi
        uses: pulumi/setup-pulumi@v2

      - name: Setup Stack
        run: |
          cd pulumi_project
          pulumi stack select ${{ github.event.inputs.stack }} || pulumi stack init ${{ github.event.inputs.stack }}
          pulumi config set aws:region ${{ env.AWS_REGION }}

      - name: Generate Visual Preview
        if: github.event.inputs.review_type == 'preview'
        run: |
          cd pulumi_project
          echo "🔍 Generating Pulumi Console Preview..."
          echo "📊 This will create a visual preview in Pulumi Console"
          echo "🌐 Check the Pulumi Console URL in the output below"
          pulumi preview --stack ${{ github.event.inputs.stack }} --show-replacement-steps --show-config
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Generate Detailed Analysis
        if: github.event.inputs.review_type == 'detailed'
        run: |
          cd pulumi_project
          echo "📋 Detailed Infrastructure Analysis"
          echo "================================="
          echo ""
          echo "🏗️  Resources to be created:"
          echo "============================"
          pulumi preview --stack ${{ github.event.inputs.stack }} > detailed-preview.txt
          cat detailed-preview.txt | grep -E "(create|update|delete|replace)" || echo "No changes detected"
          echo ""
          echo "🔧 Resource Details:"
          echo "==================="
          cat detailed-preview.txt | grep -E "aws:" | head -30 || echo "No AWS resources found"
          echo ""
          echo "💰 Estimated Costs:"
          echo "=================="
          echo "Note: Cost estimation requires Pulumi Cloud subscription"
          echo "Check Pulumi Console for detailed cost breakdown"
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Generate Visual Diagram
        if: github.event.inputs.review_type == 'diagram'
        run: |
          cd pulumi_project
          echo "📊 Generating Visual Infrastructure Diagram..."
          echo "🚀 Deploying resources to create visual diagram in Pulumi Console"
          echo "📈 This will create actual resources and generate visual diagrams"
          echo ""
          echo "⚠️  WARNING: This will create/update actual AWS resources!"
          echo "💰 You will be charged for the resources created"
          echo ""
          echo "🔗 Pulumi Console URL will be available after deployment"
          echo "📊 Visual diagrams will be available in the Pulumi Console"
          echo ""
          # Deploy to create visual diagrams
          pulumi up --stack ${{ github.event.inputs.stack }} --yes --show-replacement-steps
          echo ""
          echo "✅ Deployment completed!"
          echo "📊 Check the Pulumi Console for visual diagrams:"
          echo "   https://app.pulumi.com"
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Generate Safe Diagram Preview
        if: github.event.inputs.review_type == 'safe-diagram'
        run: |
          cd pulumi_project
          echo "📊 Safe Infrastructure Diagram Preview"
          echo "===================================="
          echo ""
          echo "🔍 This will show what resources would be created"
          echo "📈 Use 'diagram' option to actually deploy and see visual diagrams"
          echo ""
          echo "📋 Resource Summary:"
          echo "==================="
          pulumi preview --stack ${{ github.event.inputs.stack }} > safe-diagram-preview.txt
          echo "🏗️  Resources to be created:"
          cat safe-diagram-preview.txt | grep -E "(create|update|delete|replace)" || echo "No changes detected"
          echo ""
          echo "📊 Resource Types:"
          echo "=================="
          cat safe-diagram-preview.txt | grep -E "aws:" | head -20 || echo "No AWS resources found"
          echo ""
          echo "💡 To see actual visual diagrams:"
          echo "   1. Use the 'diagram' review type (will deploy resources)"
          echo "   2. Or manually run: pulumi up --stack ${{ github.event.inputs.stack }}"
          echo "   3. Then visit: https://app.pulumi.com"
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Create Review Summary
        run: |
          echo "📋 Review Summary"
          echo "================"
          echo "Stack: ${{ github.event.inputs.stack }}"
          echo "Review Type: ${{ github.event.inputs.review_type }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date)"
          echo ""
          echo "🔗 Pulumi Console: https://app.pulumi.com"
          echo "📊 Check the console for visual diagrams and detailed resource information"
          echo ""
          echo "✅ Review completed successfully!" 